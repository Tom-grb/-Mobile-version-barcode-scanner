"use strict";const e=require("../../common/vendor.js"),o=e.er.database(),t=e.er.importObject("goodsExportImport"),n={data:()=>({userInfo:{},newNickname:"",feedbackContent:"",mobile:"",tmpurl:""}),onLoad(){this.getUserInfo()},methods:{handleModel(){e.index.navigateTo({url:"/pages/subpack/explanation/explanation"})},isJSON(e){try{return JSON.parse(e),!0}catch(o){return!1}},gotoLogin(){e.index.showToast({title:"未登录/登录过期",icon:"none"}),setTimeout((()=>{e.index.navigateTo({url:"../../uni_modules/uni-id-pages/pages/login/login-withoutpwd"})}),1e3)},async getUserInfo(){try{let o=e.index.getStorageSync("uni-id-pages-userInfo");this.isJSON(o)&&(o=JSON.parse(o)),this.userInfo=o||{}}catch(o){console.error("获取用户信息时发生错误:",o)}},showNicknameInput(){if(console.log(this.userInfo.nickname),void 0===this.userInfo.nickname)return console.log(this.userInfo.nickname),void this.gotoLogin();this.newNickname=this.userInfo.nickname||"未知",this.$refs.nicknamePopup.open()},closeNicknamePopup(){this.$refs.nicknamePopup.close()},changeAvatar(){void 0!==this.userInfo.avatar_file?e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async t=>{const n=t.tempFilePaths[0];e.index.showLoading({title:"上传中..."}),console.log(n);try{const t=await e.er.uploadFile({filePath:n,cloudPath:`avatar/${Date.now()}_${Math.random().toString(36).substring(2,8)}.jpg`});let i=(await e.er.getTempFileURL({fileList:[t.fileID]})).fileList[0].tempFileURL;const s=i.indexOf("?");-1!==s&&(i=i.substring(0,s)),await o.collection("uni-id-users").doc(this.userInfo._id).update({avatar_file:i}),this.userInfo.avatar_file=i,e.index.setStorageSync("uni-id-pages-userInfo",JSON.stringify(this.userInfo)),e.index.hideLoading(),e.index.showToast({title:"头像更新成功",icon:"success"})}catch(i){console.error("头像更新失败:",i),e.index.hideLoading(),e.index.showToast({title:i.message||"上传失败",icon:"error"})}},fail:o=>{console.error("选择图片失败:",o),e.index.showToast({title:"选择图片失败",icon:"none"})}}):this.gotoLogin()},async updateNickname(){if(this.newNickname.trim())try{console.log(this.userInfo._id),await o.collection("uni-id-users").where("_id==$env.uid").update({nickname:this.newNickname}),this.userInfo.nickname=this.newNickname,e.index.setStorageSync("uni-id-pages-userInfo",JSON.stringify(this.userInfo)),this.closeNicknamePopup(),e.index.showToast({title:"昵称更新成功",icon:"success"})}catch(t){e.index.showToast({title:"更新失败",icon:"error"})}else e.index.showToast({title:"昵称不能为空",icon:"none"})},async handleImport(){try{const n=(await e.index.chooseMessageFile({count:1,type:"file",extension:["xlsx",".xlsx"]})).tempFiles[0].path,i=e.wx$1.getFileSystemManager();let s;try{s=i.readFileSync(n,"base64")}catch(o){return void e.index.showToast({title:"读取文件失败",icon:"none",duration:2e3})}const a=e.readSync(s,{type:"base64"}),c=a.Sheets[a.SheetNames[0]],r=e.utils.sheet_to_json(c,{header:1});r.shift(),console.log(r);const l=r.some((e=>{const o=e[2];return!("number"==typeof o&&!isNaN(o)&&Number(o)>=0)})),d=r.some((e=>{const o=e[1];return!o||""===o.trim()})),u=r.some((e=>{const o=e[3];return!(""===o||null==o||"number"==typeof o&&!isNaN(o)&&Number(o)>=0)}));if(l)return void e.index.showToast({title:"价格列包含非数字或者负数,请修改后重新上传",icon:"none",duration:2e3});if(d)return void e.index.showToast({title:"商品名称不能为空",icon:"none",duration:2e3});if(u)return void e.index.showToast({title:"数量列包含非数字或者负数,请修改后重新上传",icon:"none",duration:2e3});console.log(r);const p=await t.importGoods(r);if(console.log("返回",p),500===p.code)e.index.showToast({title:p.message,icon:"none",duration:2e3});else{if(-1===p.code)return void this.gotoLogin();e.index.showToast({title:p.message,icon:"none",duration:2e3})}}catch(o){console.log(o)}},async handleExport(){try{const o=await t.exportGoods();if(200===o.code)this.tmpurl=o.downloadUrl,this.$refs.exportPopup.open(),this.coypContent(this.tmpurl);else{if(-1===o.code)return void this.gotoLogin();e.index.showToast({title:"导出失败",icon:"none"})}}catch(o){e.index.showToast({title:"导出失败",icon:"none"})}},coypContent(){e.index.setClipboardData({data:this.tmpurl,success:()=>{e.index.showToast({title:"复制成功",icon:"success"})},fail:()=>{e.index.showToast({title:"复制失败",icon:"none"})}})},closeexportPopup(){this.$refs.exportPopup.close()},async showFeedback(){const e=await t.checkLogin();console.log(e.code),-1!==e.code?this.$refs.feedbackPopup.open():this.gotoLogin()},closeFeedbackPopup(){this.$refs.feedbackPopup.close(),this.feedbackContent=""},async submitFeedback(){if(this.feedbackContent.trim())if(""!==this.mobile){if(!/^1[3-9]\d{9}$/.test(this.mobile))return console.log(this.mobile),void e.index.showToast({title:"请输入有效的手机号",icon:"none"});try{const t=await o.collection("opendb-feedback").add({user_id:this.userInfo._id,content:this.feedbackContent,mobile:this.mobile,create_date:Date.now()});console.log(t),this.closeFeedbackPopup(),e.index.showToast({title:"反馈提交成功",icon:"success"})}catch(t){console.log(t),e.index.showToast({title:"提交失败",icon:"error"})}}else e.index.showToast({title:"手机号不能为空",icon:"none"});else e.index.showToast({title:"请输入反馈内容",icon:"none"})}}};if(!Array){e.resolveComponent("uni-popup")()}Math;const i=e._export_sfc(n,[["render",function(o,t,n,i,s,a){return{a:s.userInfo.avatar_file||"/static/default-avatar.png",b:e.o(((...e)=>a.changeAvatar&&a.changeAvatar(...e))),c:e.t(s.userInfo.nickname||"未登录"),d:e.o(((...e)=>a.showNicknameInput&&a.showNicknameInput(...e))),e:e.o(((...e)=>a.handleModel&&a.handleModel(...e))),f:e.o(((...e)=>a.handleImport&&a.handleImport(...e))),g:e.o(((...e)=>a.handleExport&&a.handleExport(...e))),h:e.o(((...e)=>a.showFeedback&&a.showFeedback(...e))),i:s.newNickname,j:e.o((e=>s.newNickname=e.detail.value)),k:e.o(((...e)=>a.closeNicknamePopup&&a.closeNicknamePopup(...e))),l:e.o(((...e)=>a.updateNickname&&a.updateNickname(...e))),m:e.sr("nicknamePopup","1265ce88-0"),n:e.p({type:"center"}),o:s.mobile,p:e.o((e=>s.mobile=e.detail.value)),q:s.feedbackContent,r:e.o((e=>s.feedbackContent=e.detail.value)),s:e.o(((...e)=>a.closeFeedbackPopup&&a.closeFeedbackPopup(...e))),t:e.o(((...e)=>a.submitFeedback&&a.submitFeedback(...e))),v:e.sr("feedbackPopup","1265ce88-1"),w:e.p({type:"center"}),x:s.tmpurl,y:e.o((e=>s.tmpurl=e.detail.value)),z:e.o(((...e)=>a.coypContent&&a.coypContent(...e))),A:e.o(((...e)=>a.closeexportPopup&&a.closeexportPopup(...e))),B:e.sr("exportPopup","1265ce88-2"),C:e.p({type:"center"})}}]]);wx.createPage(i);
